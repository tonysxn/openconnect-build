name: Build OpenConnect

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  # --- СБОРКА ПОД LINUX ---
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: master

      - name: Install Dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config \
          libxml2-dev libssl-dev liblz4-dev zlib1g-dev \
          gettext autoconf automake libtool

      - name: Configure and Build
        run: |
          ./autogen.sh
          ./configure --with-vpnc-script=/etc/vpnc/vpnc-script
          make

      - name: Upload Linux Binary
        uses: actions/upload-artifact@v4
        with:
          name: openconnect-linux
          path: .libs/openconnect
          if-no-files-found: error

  # --- СБОРКА ПОД WINDOWS (native MSYS2) ---
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v3
        with:
          ref: master

      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-openssl
            mingw-w64-x86_64-libxml2
            mingw-w64-x86_64-lz4
            mingw-w64-x86_64-zstd
            mingw-w64-x86_64-gettext
            mingw-w64-x86_64-jq
            autotools
            automake-wrapper

      - name: Configure and Build (Windows)
        run: |
          # Fix configure.ac syntax error (missing brackets in AC_CONFIG_FILES)
          sed -i 's/AC_CONFIG_FILES(/AC_CONFIG_FILES([/' configure.ac
          sed -i 's/tests\/configs\/test-user-pass.config)/tests\/configs\/test-user-pass.config])/' configure.ac
          
          ./autogen.sh
          ./autogen.sh
          # Указываем, что собираем для Windows 64-bit
          # LDFLAGS="-static" нужен для того, чтобы не тащить за собой DLL
          ./configure --with-vpnc-script=vpnc-script-win.js LDFLAGS="-static"
          make

      - name: Upload Windows Binary
        uses: actions/upload-artifact@v4
        with:
          name: openconnect-windows
          path: |
            .libs/openconnect.exe
            vpnc-script-win.js
          if-no-files-found: error

  # --- СОЗДАНИЕ РЕЛИЗА ---
  release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Latest Build
          tag_name: latest
          files: |
            artifacts/openconnect-linux/openconnect
            artifacts/openconnect-windows/openconnect.exe
            artifacts/openconnect-windows/vpnc-script-win.js
            artifacts/openconnect-macos/openconnect
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # --- СБОРКА ПОД MACOS ---
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: master

      - name: Install Dependencies (macOS)
        run: |
          brew install automake autoconf libtool pkg-config \
          libxml2 openssl lz4 zstd gettext

      - name: Configure and Build
        run: |
          ./autogen.sh
          # На Mac нужно указать пути к библиотекам OpenSSL, так как Apple использует свои версии
          # Используем brew --prefix для поддержки как Intel, так и Apple Silicon
          OPENSSL_PREFIX=$(brew --prefix openssl@3)
          export LDFLAGS="-L${OPENSSL_PREFIX}/lib"
          export CPPFLAGS="-I${OPENSSL_PREFIX}/include"
          export PKG_CONFIG_PATH="${OPENSSL_PREFIX}/lib/pkgconfig"
          
          # vpnc-script тоже может быть в разных местах
          VPNC_SCRIPT=$(brew --prefix)/etc/vpnc-script
          
          # --disable-shared чтобы libopenconnect была вшита внутрь, и не требовала dylib
          # LIBS="-framework PCSC" нужен для разрешения символов PCSC (Yubikey) при статической линковке
          ./configure --with-vpnc-script=${VPNC_SCRIPT} --disable-shared LIBS="-framework PCSC"
          make

      - name: Upload macOS Binary
        uses: actions/upload-artifact@v4
        with:
          name: openconnect-macos
          path: openconnect
          if-no-files-found: error